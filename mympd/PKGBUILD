# Based on ympd-git from AUR made by the following people:
# Maintainer: Philippe Mongeau <ph.mongeau@gmail.com>
# Maintainer: Mike Andonov <info@archphile.org>

pkgname=mympd
_pkgname=myMPD
pkgver=3.2.1
pkgrel=1
pkgdesc="A standalone MPD Web GUI based on YMPD - Default port set to 80"
arch=('armv7h' 'aarch64')
url="http://github.org/jcorporation"
license=('BSD')
depends=('libmpdclient' 'openssl')
makedepends=('cmake' 'git')
optdepends=()
provides=()
conflicts=()
replaces=()
install=post.install
source=("https://github.com/jcorporation/${_pkgname}/archive/v${pkgver}.tar.gz"
        'post.install')
sha256sums=('f22d41e0ca8e31762d53947d2114853dba59bf99dfd9b7972846834aedb1ee9f'
            'c7addf94ff814b631c8807dd3551f1fceeb3cbcca259239fd9aedf1f8199ce68')

build() {
if [ -f ${srcdir}/${_pkgname}-${pkgver}/buildtools/closure-compiler.jar ]
then
  echo "Minifying javascript"
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.js -nt ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.min.js ] && \
    java -jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/closure-compiler.jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.js > ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.min.js
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.js -nt  ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.min.js ] && \
    java -jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/closure-compiler.jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.js > ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.min.js
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.js -nt ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.min.js ] && \
    java -jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/closure-compiler.jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.js > ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.min.js
else
  echo "buildtools/closure-compiler.jar not found, using non-minified files"
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.js -nt ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.min.js ] && \
    cp ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.js ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/player.min.js
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.js -nt  ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.min.js ] && \
    cp ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.js  ${srcdir}/${_pkgname}-${pkgver}/buildtools/js/mpd.min.js
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.js -nt ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.min.js ] && \
    cp ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.js ${srcdir}/${_pkgname}-${pkgver}/buildtools/sw.min.js    
fi

if [ -f ${srcdir}/${_pkgname}-${pkgver}/buildtools/closure-stylesheets.jar ]
then
  echo "Minifying stylesheets"
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.css -nt ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.min.css ] && \
    java -jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/closure-stylesheets.jar ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.css > ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.min.css
else
  echo "buildtools/closure-stylesheets.jar not found, using non-minified files"
  [ ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.css -nt ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.min.css ] && \
    cp ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.css ${srcdir}/${_pkgname}-${pkgver}/buildtools/css/mpd.min.css    
fi
  
  cd "${srcdir}/${_pkgname}-${pkgver}"
  
  [ -d release ] || mkdir release
  cd release
  cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCMAKE_BUILD_TYPE=RELEASE ..
  make
}

package() {
  cd "${srcdir}/${_pkgname}-${pkgver}/release"
  make DESTDIR="$pkgdir/" install

  echo "Replacing javascript and stylesheets with minified files"
  sed -i -e 's/mpd\.css/mpd\.min\.css/' -e 's/mpd\.js/mpd\.min\.js/' $pkgdir/usr/share/mympd/htdocs/index.html
  sed -i -e 's/mpd\.css/mpd\.min\.css/' -e 's/player\.js/player\.min\.js/' $pkgdir/usr/share/mympd/htdocs/player.html
  sed -i -e 's/mpd\.css/mpd\.min\.css/' -e 's/mpd\.js/mpd\.min\.js/' -e 's/player\.js/player\.min\.js/' $pkgdir/usr/share/mympd/htdocs/sw.min.js
  sed -i -e 's/\/sw\.js/\/sw\.min\.js/' $pkgdir/usr/share/mympd/htdocs/js/mpd.min.js
  echo "Minifying html"
  perl -i -pe 's/^\s*//gm; s/\s*$//gm' $pkgdir/usr/share/mympd/htdocs/index.html
  perl -i -pe 's/^\s*//gm; s/\s*$//gm' $pkgdir/usr/share/mympd/htdocs/player.html

  if [ -d /etc/systemd/system ]
  then
    if [ ${srcdir}/${_pkgname}-${pkgver}/contrib/mympd.service -nt /etc/systemd/system/mympd.service ]
    then
      [[ -d $pkgdir/usr/lib/systemd/system/ ]] || mkdir -p $pkgdir/usr/lib/systemd/system/
      cp -v ${srcdir}/${_pkgname}-${pkgver}/contrib/mympd.service $pkgdir/usr/lib/systemd/system/
    fi
  fi

  # FIXES FOR OPTIONS 
  sed 's/^SSL/#SSL/' -i "$pkgdir/etc/mympd/options"
  sed '/COVERIMAGE=--coverimage folder.jpg/c COVERIMAGE=folder.jpg' -i "$pkgdir/etc/mympd/options"
  sed '/STATEFILE=--statefile \/var\/lib\/mympd\/mympd.state/c STATEFILE=\/var\/lib\/mympd\/mympd.state' -i "$pkgdir/etc/mympd/options"

  # FIXES FOR SERVICE FILE
  sed '/Requires=/s/$/ mpd.service/' -i "$pkgdir/usr/lib/systemd/system/mympd.service"
  sed '/Environment=COVERIMAGE=--coverimage folder.jpg/c Environment=COVERIMAGE=folder.jpg' -i "$pkgdir/usr/lib/systemd/system/mympd.service"
  sed '/Environment=STATEFILE=--statefile \/var\/lib\/mympd\/mympd.state/c Environment=STATEFILE=\/var\/lib\/mympd\/mympd.state' -i "$pkgdir/usr/lib/systemd/system/mympd.service"
  sed 's/$COVERIMAGE/--coverimage $COVERIMAGE/g' -i "$pkgdir/usr/lib/systemd/system/mympd.service"
  sed 's/$STATEFILE/--statefile  $STATEFILE/g' -i "$pkgdir/usr/lib/systemd/system/mympd.service"
}

