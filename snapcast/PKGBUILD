# Maintainer: robot <cultofrobots [at] protonmail [dot] com>
# Website: https://github.com/CultofRobots
# Based on PKGBUILD from AUR
# Contributor: Bart De Vries <devriesb [at] gmail [dot] com>

pkgname=snapcast
pkgver=0.22.0
pkgrel=1
pkgdesc="Synchronous multi-room audio player"
arch=('x86_64' 'armv6h' 'armv7h' 'aarch64')
url="https://github.com/badaix/snapcast"
license=('GPL')
depends=(alsa-lib avahi libvorbis flac opus expat libsoxr)
makedepends=(alsa-utils boost)
install="snapcast.install"
backup=('etc/default/snapserver' 'etc/default/snapclient' 'etc/snapserver.conf')
source=("${pkgname}-${pkgver}.tar.gz::https://github.com/badaix/snapcast/archive/v${pkgver}.tar.gz"
        "snapcast.sysusers"
        "snapcast.tmpfiles"
        "snapcast.install")
sha256sums=('8a332a0a02792b9f5f704c25a505db36dd743eeee9c696e4e8fc1ef33c73d640'
            '9fe6e9e07adb77f555a617b772e6d01e098e1dfaad1e8075e03a7d7ba76141de'
            '1c58fef5d3e2de64c1df52138f0f3c841773e7881b9cbc76f23312deeebc11b5'
            '98cfdc3221270e3243f7dd0ca32f8c4b271258f32fc04fdb52a286f0986d7350')

build() {
  cd "${pkgname}-${pkgver}"
  make
}

package() {
  cd "${pkgname}-${pkgver}"
  install -Dm755 server/snapserver "${pkgdir}/usr/bin/snapserver"
  install -Dm644 server/snapserver.1 "${pkgdir}/usr/share/man/man1/snapserver.1"
  install -Dm644 server/etc/snapserver.conf "${pkgdir}/etc/snapserver.conf"

  # install snapweb
  for file in server/etc/snapweb/*\.*; 
    do install -Dm 644 ${file} -t "${pkgdir}/usr/share/snapserver/snapweb/"; 
  done
  for file in server/etc/snapweb/3rd-party/*\.*;
    do install -Dm 644 ${file} -t "${pkgdir}/usr/share/snapserver/snapweb/3rd-party/";
  done

  install -Dm755 client/snapclient "${pkgdir}/usr/bin/snapclient"
  install -Dm644 client/snapclient.1 "${pkgdir}/usr/share/man/man1/snapclient.1"

  install -Dm644 debian/snapserver.service "${pkgdir}/usr/lib/systemd/system/snapserver.service"
  install -Dm644 debian/snapserver.default "${pkgdir}/etc/default/snapserver"
  install -Dm644 debian/snapclient.service "${pkgdir}/usr/lib/systemd/system/snapclient.service"
  install -Dm644 debian/snapclient.default "${pkgdir}/etc/default/snapclient"

  install -Dm644 "${srcdir}/snapcast.sysusers" "${pkgdir}/usr/lib/sysusers.d/snapclient.conf"
  install -Dm644 "${srcdir}/snapcast.tmpfiles" "${pkgdir}/usr/lib/tmpfiles.d/snapclient.conf"

  # install documentation
  install -d "${pkgdir}/usr/share/doc/${pkgname}"
  cp -R doc/* "${pkgdir}/usr/share/doc/${pkgname}/"

  find "${pkgdir}"/usr/share/doc/${pkgname} -type f -exec chmod 0644 {} \;
  find "${pkgdir}"/usr/share/doc/${pkgname} -type d -exec chmod 0755 {} \;
}
